function queryStringToJSON(e){if(""===e)return"";var t=e.split("?");if(2!=t.length)return"";var n=t[1].split("&"),i={};for(var a in n){var o=n[a].split("=");o[0]&&(i[o[0].toLowerCase()]=decodeURIComponent(o[1]||""))}return i}function build_highmap(e,t){if(e.map&&e.map.data){$("#highmap").width($("#explore-tabs").width());var n,a,o,r;if("crosstab"==e.type)if(void 0==t){for($("#highmap-filter-container #highmap-filter-header").html($("#highmap-filter-container #highmap-filter-header").data("orig").replace("[replace]",e.map.filter)),$("#highmap-filter-container #highmap-default-id").html(e.map.filters[0][1]),$("#highmap-filter-container ul").empty(),i=0;i<e.map.filters.length;i++)$("#highmap-filter-container ul").append('<li class="map_filter"><a href="#" data-id="'+e.map.filters[i][0]+'">'+e.map.filters[i][1]+"</a></li>");$("#highmap-filter-container").show(),$("#highmap-filter-container ul li.map_filter a").on("click",function(e){e.preventDefault();var t=$(this).html(),n=$(this).data("id");$("span#highmap-default-id").text(t),highmap.showLoading(),build_highmap(json_data,n)}),n=e.map.data[e.map.filters[0][0]],r=e.map.filters[0][1],a=e.title.map_html.replace("[replace]",r),o=e.title.map_text.replace("[replace]",r)}else n=e.map.data[t],r=$('#highmap-filter-container ul li a[data-id="'+t+'"]').html(),a=e.title.map_html.replace("[replace]",r),o=e.title.map_text.replace("[replace]",r);else $("#highmap-filter-container").hide(),n=e.map.data,a=e.title.map_html,o=e.title.map_text;$("#highmap").highcharts("Map",{chart:{events:{load:function(){this.options.chart.forExport&&(Highcharts.each(this.series,function(e){"baseLayer"!=e.name&&e.update({dataLabels:{enabled:!0,color:"white",formatter:function(){return this.point.name+"<br/>"+this.point.count+"   ("+this.point.value+"%)"}}},!1)}),this.redraw())}}},title:{text:a,useHTML:!0,style:{"text-align":"center"}},subtitle:{text:e.subtitle.html,useHTML:!0,style:{"text-align":"center","margin-top":"-15px"}},mapNavigation:{enabled:!1,buttonOptions:{verticalAlign:"bottom"}},colorAxis:{min:0,max:100,labels:{formatter:function(){return this.value+"%"}}},loading:{labelStyle:{color:"white",fontSize:"20px"},style:{backgroundColor:"#000"}},series:[{data:Highcharts.geojson(highmap_shapes,"map"),name:"baseLayer",color:"#eeeeee",showInLegend:!1,tooltip:{headerFormat:"",pointFormat:"{point.name}: "+gon.na},borderColor:"#909090",borderWidth:1,states:{hover:{color:"#D6E3B5",borderColor:"#000",borderWidth:2}}},{data:n,name:e.row_question,mapData:highmap_shapes,joinBy:["name","name"],allAreas:!1,tooltip:{headerFormat:"",pointFormat:"<b>{point.name}:</b> {point.count} ({point.value}%)"},borderColor:"#909090",borderWidth:1,states:{hover:{color:"#D6E3B5",borderColor:"#000",borderWidth:2}},dataLabels:{enabled:!0,color:"white",formatter:function(){return this.point.count+"   ("+this.point.value+"%)"}}}],exporting:{sourceWidth:1280,sourceHeight:720,filename:o,chartOptions:{title:{text:o},subtitle:{text:e.subtitle.text}},buttons:{contextButton:{menuItems:[{text:gon.highcharts_png,onclick:function(){this.exportChart({type:"image/png"})}},{text:gon.highcharts_jpg,onclick:function(){this.exportChart({type:"image/jpeg"})}},{text:gon.highcharts_pdf,onclick:function(){this.exportChart({type:"application/pdf"})}},{text:gon.highcharts_svg,onclick:function(){this.exportChart({type:"image/svg+xml"})}}]}}}}),highmap=$("#highmap").highcharts(),$("#explore-tabs #nav-map").show()}else $("#explore-tabs #nav-map").hide(),$("#explore-tabs #nav-map, #explore-content #tab-map").removeClass("active")}function build_crosstab_chart(e){e.chart&&e.chart.data&&(Highcharts.setOptions({lang:{contextButtonTitle:gon.highcharts_context_title}}),$("#chart").highcharts({chart:{type:"bar"},title:{text:e.title.html,useHTML:!0,style:{"text-align":"center"}},subtitle:{text:e.subtitle.html,useHTML:!0,style:{"text-align":"center","margin-top":"-15px"}},xAxis:{categories:e.chart.labels,title:{text:e.row_question}},yAxis:{min:0,title:{text:gon.percent}},legend:{title:{text:e.column_question},reversed:!0,symbolHeight:14,itemMarginBottom:5,itemStyle:{color:"#333333",cursor:"pointer",fontSize:"14px",fontWeight:"bold"}},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.percentage:.0f}%)<br/>',shared:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",followPointer:!0},plotOptions:{bar:{stacking:"percent"}},series:e.chart.data.reverse(),exporting:{sourceWidth:1280,sourceHeight:720,filename:e.title.text,chartOptions:{title:{text:e.title.text},subtitle:{text:e.subtitle.text}},buttons:{contextButton:{menuItems:[{text:gon.highcharts_png,onclick:function(){this.exportChart({type:"image/png"})}},{text:gon.highcharts_jpg,onclick:function(){this.exportChart({type:"image/jpeg"})}},{text:gon.highcharts_pdf,onclick:function(){this.exportChart({type:"application/pdf"})}},{text:gon.highcharts_svg,onclick:function(){this.exportChart({type:"image/svg+xml"})}}]}}}}))}function build_pie_chart(e){e.chart&&e.chart.data&&(Highcharts.setOptions({lang:{contextButtonTitle:gon.highcharts_context_title}}),$("#chart").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:e.title.html,useHTML:!0,style:{"text-align":"center"}},subtitle:{text:e.subtitle.html,useHTML:!0,style:{"text-align":"center","margin-top":"-15px"}},tooltip:{formatter:function(){return"<b>"+this.key+":</b> "+this.point.options.count+" ("+this.y+"%)"}},plotOptions:{pie:{cursor:"pointer",dataLabels:{enabled:!0,format:"{point.options.count} ({point.y}%)",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}},showInLegend:!0}},legend:{symbolHeight:14,itemMarginBottom:5,itemStyle:{color:"#333333",cursor:"pointer",fontSize:"14px",fontWeight:"bold"}},series:[{type:"pie",data:e.chart.data}],exporting:{sourceWidth:1280,sourceHeight:720,filename:e.title.text,chartOptions:{title:{text:e.title.text},subtitle:{text:e.subtitle.text}},buttons:{contextButton:{menuItems:[{text:gon.highcharts_png,onclick:function(){this.exportChart({type:"image/png"})}},{text:gon.highcharts_jpg,onclick:function(){this.exportChart({type:"image/jpeg"})}},{text:gon.highcharts_pdf,onclick:function(){this.exportChart({type:"application/pdf"})}},{text:gon.highcharts_svg,onclick:function(){this.exportChart({type:"image/svg+xml"})}}]}}}}))}function build_datatable(e){$("#tab-table h3").html(e.title.html+e.subtitle.html),void 0!=datatable&&datatable.fnDestroy();var t="";if(t+="<thead>","crosstab"==e.type){for(t+="<tr class='th-center'>",t+="<th class='var1-col'></th>",t+="<th colspan='"+(2*(e.column_answers.length+1)).toString()+"'>",t+=e.column_question,t+="</th>",t+="</tr>",t+="<tr class='th-center'>",t+="<th class='var1-col'></th>",i=0;i<e.column_answers.length;i++)t+="<th colspan='2'>",t+=e.column_answers[i][1].toString(),t+="</th>";for(t+="</tr>",t+="<tr>",t+="<th class='var1-col'>",t+=e.row_question,t+="</th>",i=0;i<e.column_answers.length;i++)t+="<th>",t+=$("#datatable").data("count"),t+="</th>",t+="<th>",t+=$("#datatable").data("percent"),t+="</th>";t+="</tr>"}else t+="<tr class='th-center'>",t+="<th class='var1-col'>",t+=e.row_question,t+="</th><th>",t+=$("#datatable").data("count"),t+="</th><th>",t+=$("#datatable").data("percent"),t+="</th></tr>";if(t+="</thead>",t+="<tbody>","crosstab"==e.type)for(i=0;i<e.row_answers.length;i++){for(t+="<tr>",t+="<td class='var1-col'>",t+=e.row_answers[i][1],t+="</td>",j=0;j<e.counts[i].length;j++)t+="<td>",t+=e.counts[i][j],t+="</td>",t+="<td>",t+=e.percents[i][j].toFixed(2),t+="%</td>";t+="</tr>"}else for(i=0;i<e.row_answers.length;i++)t+="<tr>",t+="<td class='var1-col'>",t+=e.row_answers[i][1],t+="</td><td>",t+=e.counts[i],t+="</td><td>",t+=e.percents[i].toFixed(2),t+="%</td>",t+="</tr>";t+="</tbody>",$("#datatable").html(t);for(var n=[],i=1;i<$("#datatable > thead tr:last-of-type th").length;i++)n.push(i);datatable=$("#datatable").dataTable({dom:'<"top"fT>t<"clear">',language:{url:gon.datatable_i18n_url},columnDefs:[{type:"formatted-num",targets:n}],tableTools:{sSwfPath:"/assets/dataTables/extras/swf/copy_csv_xls.swf",aButtons:[{sExtends:"copy",sButtonText:gon.datatable_copy_title,sToolTip:gon.datatable_copy_tooltip},{sExtends:"csv",sButtonText:gon.datatable_csv_title,sToolTip:gon.datatable_csv_tooltip},{sExtends:"xls",sButtonText:gon.datatable_xls_title,sToolTip:gon.datatable_xls_tooltip}]}})}function build_details(e){if($("#tab-details #details-row-question, #tab-details #details-row-answers, #tab-details #details-col-question, #tab-details #details-col-answers").html(""),e.row_question&&e.row_answers){$("#tab-details #details-row-question").html(e.row_question);for(var t=0;t<e.row_answers.length;t++)$("#tab-details #details-row-answers").append("<li>"+e.row_answers[t][1]+"</li>")}if(e.column_question&&e.column_answers){$("#tab-details #details-col-question").html(e.column_question);for(var t=0;t<e.column_answers.length;t++)$("#tab-details #details-col-answers").append("<li>"+e.column_answers[t][1]+"</li>");$("#tab-details #details-col").show()}else $("#tab-details #details-col").hide()}function build_explore_data_page(e){"crosstab"==e.type?build_crosstab_chart(e):build_pie_chart(e),build_highmap(e),build_datatable(e),build_details(e),0==$("#explore-tabs li.active:visible").length&&$("#explore-tabs li:visible:first a").trigger("click")}function get_explore_data(e){void 0==e&&(e=!1);var t;if(e){var n=window.location.href.split("?");2==n.length&&(t=n[1])}else t=$("form#form-explore-data select, form#form-explore-data input:not([type=hidden])").serialize();$.ajax({type:"GET",url:gon.explore_data_ajax_path,data:t,dataType:"json"}).error(function(e,t,n){console.log("Request failed: "+t+". Error thrown: "+n)}).success(function(n){json_data=n,build_explore_data_page(n);var i=[location.protocol,"//",location.host,location.pathname,"?",t].join("");e||i==window.location.href||window.history.pushState({path:i},"",i),$("#explore-data-loader").fadeOut("slow")})}function reset_filter_form(){$("select#col").val(""),$("select#filter_variable").val(""),$("select#filter_value").val(""),$("input#exclude_dkra").removeAttr("checked"),$("select#col").selectpicker("refresh"),$("#btn-swap-vars").hide(),$("select#filter_variable").selectpicker("refresh"),$("select#filter_value").selectpicker("refresh"),$("#filter_value_container").hide()}var geojson,datatable,i,j,json_data,highmap;$(document).ready(function(){gon.explore_data&&($('a[data-toggle="tab"]').on("shown.bs.tab",function(){switch($(this).attr("href")){case"#tab-map":highmap.reflow();break;case"#tab-table":var e=TableTools.fnGetMasters();for(i in e)e[i].fnResizeRequired()&&e[i].fnResizeButtons();break;case"#tab-chart":$("#chart").highcharts().reflow()}}),$("form#form-explore-data").submit(function(){return $("#explore-data-loader").fadeIn("slow",function(){get_explore_data()}),!1}),$("form#form-explore-data input#btn-reset").click(function(e){e.preventDefault(),$("#explore-data-loader").fadeIn("slow",function(){reset_filter_form(),get_explore_data()})}),$("select.selectpicker").selectpicker(),$("select.selectpicker-filter").selectpicker(),$("select.selectpicker").change(function(){val=$(this).val(),"row"==$(this).attr("id")?($('select.selectpicker#col option[disabled="disabled"]').removeAttr("disabled"),$('select.selectpicker#col option[value="'+val+'"]').attr("disabled","disabled"),$("select.selectpicker#col").selectpicker("refresh")):"col"==$(this).attr("id")&&($('select.selectpicker#row option[disabled="disabled"]').removeAttr("disabled"),$('select.selectpicker#row option[value="'+val+'"]').attr("disabled","disabled"),$("select.selectpicker#row").selectpicker("refresh"),""==val?$("button#btn-swap-vars").fadeOut():$("button#btn-swap-vars").fadeIn());var e=$("select.selectpicker#row").val(),t=$("select.selectpicker#col").val();($("select#filter_variable").val()==e&&""!=e||$("select#filter_variable").val()==t&&""!=t)&&($("select#filter_variable").selectpicker("val",""),$("#filter_value_container").fadeOut(),$("select#filter_value option:not([disabled])").attr("disabled","disabled"),$("select#filter_value").selectpicker("refresh"),$("select#filter_value").selectpicker("render")),$('select#filter_variable option[disabled="disabled"]').removeAttr("disabled"),$('select#filter_variable option[value="'+e+'"]').attr("disabled","disabled"),$('select#filter_variable option[value="'+t+'"]').attr("disabled","disabled"),$("select#filter_variable").selectpicker("refresh"),$("select#filter_variable").selectpicker("render")}),$("select#filter_variable").change(function(){var e=$(this).val();""==e?($("#filter_value_container").fadeOut(),$("select#filter_value option:not([disabled])").attr("disabled","disabled")):($("select#filter_value option:not([disabled])").attr("disabled","disabled"),$('select#filter_value option[data-code="'+e+'"]').removeAttr("disabled"),$("#filter_value_container").fadeIn()),$('select#filter_value option[data-code="'+e+'"]:first').attr("selected","selected"),$("select#filter_value").selectpicker("refresh"),$("select#filter_value").selectpicker("render")}),$("button#btn-swap-vars").click(function(){var e=$("select#row").val(),t=$("select#col").val();$('select#row option[value="'+t+'"]').removeAttr("disabled"),$('select#col option[value="'+e+'"]').removeAttr("disabled"),$("select#row").selectpicker("refresh"),$("select#col").selectpicker("refresh"),$("select#row").selectpicker("val",t),$("select#col").selectpicker("val",e),$("select#row").selectpicker("render"),$("select#col").selectpicker("render"),$('select#row option[value="'+e+'"]').attr("disabled","disabled"),$('select#col option[value="'+t+'"]').attr("disabled","disabled"),$("select#row").selectpicker("refresh"),$("select#col").selectpicker("refresh"),$("input#btn-submit").trigger("click")}),jQuery.fn.dataTableExt.oSort["formatted-num-asc"]=function(e,t){var n=e.match(/\d/)?e.replace(/\s\(\d{0,}.?\d{0,}\%\)/g,""):0,i=t.match(/\d/)?t.replace(/\s\(\d{0,}.?\d{0,}\%\)/g,""):0;return parseFloat(n)-parseFloat(i)},jQuery.fn.dataTableExt.oSort["formatted-num-desc"]=function(e,t){var n=e.match(/\d/)?e.replace(/\s\(\d{0,}.?\d{0,}\%\)/g,""):0,i=t.match(/\d/)?t.replace(/\s\(\d{0,}.?\d{0,}\%\)/g,""):0;return parseFloat(i)-parseFloat(n)},$("#explore-data-loader").fadeIn("slow",function(){get_explore_data()}),$(window).bind("popstate",function(){params=queryStringToJSON(window.location.href),params.row!=$("select#row").val()&&($("select#row").val(void 0==params.row?"":params.row),$("select#row").selectpicker("refresh")),params.col!=$("select#col").val()&&($("select#col").val(void 0==params.col?"":params.col),$("select#col").selectpicker("refresh")),""==$("select#col").val()?$("#btn-swap-vars").hide():$("#btn-swap-vars").show(),params.filter_variable!=$("select#filter_variable").val()&&($("select#filter_variable").val(void 0==params.filter_variable?"":params.filter_variable),$("select#filter_variable").selectpicker("refresh")),""==params.filter_variable?($("#filter_value_container").fadeOut(),$("select#filter_value option:not([disabled])").attr("disabled","disabled")):($("select#filter_value").val(""),$("select#filter_value option:not([disabled])").attr("disabled","disabled"),$('select#filter_value option[data-code="'+params.filter_variable+'"]').removeAttr("disabled"),$('select#filter_value option[data-code="'+params.filter_variable+'"][value="'+params.filter_value+'"]').attr("selected","selected"),$("#filter_value_container").fadeIn()),$("select#filter_value").selectpicker("refresh"),"true"==params.exclude_dkra?$("input#exclude_dkra").attr("checked","checked"):$("input#exclude_dkra").removeAttr("checked"),$("#explore-data-loader").fadeIn("slow",function(){get_explore_data(!0)})}))});