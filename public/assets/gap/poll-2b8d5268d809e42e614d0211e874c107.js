var poll={p:null,stage:null,stage_d3:null,ftmp:null,mtmp:null,previous_scroll_time:0,knobCX:210,knobCY:210,knobR:210,knobC:"green",indicatorRadius:8,degrees_male:[1,47,313],degrees_female:[0,133,227],degrees:null,degree_steps:[],degree_step:0,next_function:null,npicker_function:null,stage_size:400,stage_size2:0,stage_w:400,stage_h:400,npicker_sal_size:5,show:function(){poll.stage_size2=poll.stage_size/2,scr_clean(),this.init(),0==steptogo?this.gender():(poll.draw_character(),fn(hash_map[steptogo-1].nf),steptogo>=1&&poll.create_prev_button()),this.create_next_button()},init:function(){s3.append("div").classed("poll",!0).selectAll("div").data(["poll-label","stage"]).enter().append("div").attr("class",function(t){return t}),this.stage=s.find(".stage"),this.stage_d3=s3.select(".stage")},add_layer:function(){poll.stage_d3.select(".character").style("background-color","transparent"),poll.stage_d3.insert("svg",".character").classed({"stage-bk":!0,abs:!0}).style({width:poll.stage_w+2,height:poll.stage_h+2,top:h/2-poll.stage_h/2+1,left:w/2-poll.stage_w/2+1}).append("circle").classed("bk",!0).attr({cx:poll.stage_w/2+1,cy:poll.stage_h/2+1,r:poll.stage_w/2}),poll.stage_d3.insert("div").classed("poll-sub-label abs",!0)},draw_character:function(){$(".poll").addClass(g()),$('<div class="'+g()+'char character" title="Female"></div>').appendTo(this.stage),poll.add_layer();var t=isf(),e=document.getElementsByClassName("character")[0],n=e.clientHeight,r=e.clientWidth,e=s3.select(".character").style({width:poll.stage_w+"px",height:poll.stage_h+"px",top:h/2-poll.stage_h/2+"px",left:w/2-poll.stage_w/2+"px","background-size":"184px 400px","background-position":(t?poll.stage_w-r:r-184)+"px "+(n-n/1.5)+"px"})},character_picked:function(){is=!0;var t={width:poll.stage_w,height:poll.stage_h,top:h/2-poll.stage_h/2,left:w/2-poll.stage_w/2},e=isf(),n=e?"fcharh":"mcharh",r=$(e?".fchar":".mchar"),i=$(e?".mchar":".fchar");i.removeClass("selected").fadeOut(1e3,"linear",function(){$(this).remove()}),r.addClass("selected").removeClass("b").animate(t,{duration:1e3,progress:function(t,n){tmp_width=r.width(),tmp_height=r.height(),$(this).css("background-size",46*n*4+"px "+100*n*4+"px"),$(this).css("background-position",e?tmp_width*n-46*n*4+"px "+(tmp_height-tmp_height/1.5*n)+"px":tmp_width-tmp_width*n+"px "+(tmp_height-tmp_height/1.5*n)+"px")},complete:function(){$(this).removeClass("selected "+n),poll.add_layer("selected "+n),poll.age(),is=!1}})},gender:function(){poll.label(locale.poll.choose_gender);var t=100,e=poll.stage_d3.append("div").classed("fchar fcharh character b",!0).attr("title","Female").style({top:h/2-male.canvas/2+"px",left:w/2-t/2-male.canvas+"px"}).on("click",function(){f(),poll.place_human_based_on_gender(),poll.character_picked(),poll.create_prev_button(),d3.select(this).on("click",null)}),n=poll.stage_d3.append("div").classed("mchar mcharh character b",!0).attr("title","Male").style({top:h/2-male.canvas/2+"px",left:w/2+t/2+"px"}).on("click",function(){m(),poll.place_human_based_on_gender(),poll.character_picked(),poll.create_prev_button(),d3.select(this).on("click",null)});onscrollafter=function(){e.classed("selected")?(e.classed("selected",!1),n.classed("selected",!0),m()):n.classed("selected")?(n.classed("selected",!1),e.classed("selected",!0),f()):(e.classed("selected",!0),f()),player.play("select")},poll.next_function=function(){is||("n"!=g()?isf()?poll.stage_d3.select(".fchar").on("click")():poll.stage_d3.select(".mchar").on("click")():(switchStyle(".mchar",1e3,500,"sin-in","sin-out","background-color",color.female,color.white),switchStyle(".fchar",1e3,500,"sin-in","sin-out","background-color",color.male,color.white)))}},age:function(){onscrollafter=null,poll.label(locale.poll.choose_age),params_set(1),s3.select(".poll").classed(g(),!0),poll.next_function=function(){onscrolldown=null,onscrollup=null,$(document).off("mousedown"),$(".age-mover").draggable("destroy"),poll.stage_d3.select(".age-picker").remove(),poll.category()},poll.age_picker_show()},category:function(){poll.label(locale.poll.choose_category),params_set(2),user.category=null==user.category?cat_ids[0]:user.category,poll.npicker_function=null,poll.next_function=function(){poll.choose_category(),onscrolldown=null,onscrollup=null,user.salary=poll.category_salary(),poll.stage_d3.select(".category-picker").remove(),poll.stage_d3.select(".salary-picker").remove(),poll.interest()},poll.category_picker_show()},interest:function(){poll.label(locale.poll.choose_interest),params_set(4),user.interest=null==user.interest?int_ids[0]:user.interest,poll.next_function=function(){poll.choose_interest(),onscrolldown=null,onscrollup=null,poll.npicker_function=null,$(".character").off(),poll.stage_d3.select(".interest-picker").remove(),poll.stage_d3.select(".percent-picker").remove(),params_set(6),game_init()},poll.interest_picker_show()},category_picker_show:function(){var t=280,e=30,n=2*e,r=360/categories.length,i=poll.stage_d3.append("div").classed("category-picker",!0);poll.npicker_create(".stage",".salary-picker",99999,poll.npicker_sal_size,h2,w2+(isf()?-180:0),user.salary);var o=i.selectAll("svg").data(categories).enter().append("svg").attr("class",function(){return"category_item "+g()}).attr("id",function(t){return"c"+t.id}).attr({width:n,height:n}).style("top",function(n,i){return h2+t*Math.sin(Math.radians(i*r))-e}).style("left",function(n,i){return w2-t*Math.cos(Math.radians(i*r))-e}).on("click",function(t){poll.by_category(t.id)});o.append("circle").attr({cx:e,cy:e,r:e}),o.append("text").text(function(t){return t.name.substr(0,4)}).attr({x:12,y:35}),poll.category_draw(),onscrollup=function(){poll.category_down()},onscrolldown=function(){poll.category_up()}},category_draw:function(){d3.selectAll(".category-picker .category_item").classed("selected",!1),poll.sublabel(d3.select(".category-picker .category_item#c"+user.category).classed("selected",!0).select("text").text())},category_up:function(){var t=cat_ids.indexOf(user.category);-1!=t&&(user.category=t<categories.length-1?cat_ids[t+1]:cat_ids[0]),this.category_draw()},category_down:function(){var t=cat_ids.indexOf(user.category);-1!=t&&(user.category=t>0?cat_ids[t-1]:cat_ids[categories.length-1]),this.category_draw()},by_category:function(t){user.category!=t&&(user.category=t,this.category_draw())},category_salary:function(t){return exist(t)?void poll.npicker_set(".salary-picker",t,poll.npicker_sal_size):poll.npicker_get(".salary-picker.npicker",poll.npicker_sal_size)},age_picker_show:function(){var t=this.stage_d3.append("svg").attr({"class":g()+" age-picker"}).style({x:"0px",y:"0px",height:"420px",width:"420px",top:h/2-210,left:w/2-210});t.append("path").attr({fill:"none",stroke:"#231F20","stroke-miterlimit":"10",d:isf()?"M66.726,363.473c-40.734-38.326-66.17-92.732-66.17-153.076c0-60.347,25.435-114.751,66.169-153.078":"M353.304,57.544c40.734,38.328,66.17,92.732,66.17,153.078c0,60.346-25.435,114.75-66.169,153.077"}),t.append("circle").attr({"class":"age-mover",cx:"0",cy:"0",r:poll.indicatorRadius,draggable:"true",ondrag:"poll.drag_age(event)"});var e=max_age-min_age;poll.degrees=ism()?poll.degrees_male:poll.degrees_female;var n=0;n=0==poll.degrees[0]?poll.degrees[2]-poll.degrees[1]:poll.degrees[1]+360-poll.degrees[2],poll.degree_step=n/e;for(var r=0;e>=r;++r)poll.degree_steps.push(0==poll.degrees[0]?poll.degrees[1]+r*poll.degree_step:poll.degrees[1]-(e-r)*poll.degree_step);$(".age-mover").draggable(),$(document).on("mousedown",function(t){poll.agemousedown(t)}),onscrollup=function(){poll.age_up()},onscrolldown=function(){poll.age_down()},poll.by_age(user.age)},age_check:function(){user.age<min_age?user.age=min_age:user.age>max_age&&(user.age=max_age)},age_up:function(){this.age_check(),user.age<max_age&&++user.age,this.agepicker_draw()},age_down:function(){this.age_check(),user.age>min_age&&--user.age,this.agepicker_draw()},by_age:function(t){user.age=t,this.age_check(),this.agepicker_draw()},agepicker_draw:function(){var t=this.get_radian_by_age(user.age),e=Math.cos(t),n=Math.sin(t),r=this.knobR*e+this.knobCX,i=this.knobCY-this.knobR*n;$(".age-mover").attr("cx",r).attr("cy",i),poll.sublabel(user.age+"("+agegroup_by_age(user.age)+")")},agepicker_age_by_coord:function(t,e){var n=Math.atan2(e,t),r=Math.degrees(n);0>r&&(r=360+r);for(var i=!1,o=0;max_age-min_age>=o;++o){var a=(360+this.degree_steps[o])%360,s=(360+this.degree_steps[o+1])%360;if(0==poll.degrees[0]){if(r>=this.degree_steps[o]&&r<this.degree_steps[o+1]){var l=o;r-this.degree_steps[o]>this.degree_steps[o+1]-r&&++l,this.by_age(min_age+l),i=!0}}else if(same_sign(this.degree_steps[o],this.degree_steps[o+1])){if(r>=a&&s>r){var l=o;r-a>s-r&&++l,this.by_age(max_age-l),i=!0}}else if(r>=a&&360>r||r>=0&&s>r){var l=o;r>=0&&s>r&&++l,this.by_age(max_age-l),i=!0}}if(!i){var a=(360+this.degrees[1])%360,s=(360+this.degrees[2])%360;this.by_age(0==this.degrees[0]?a>r?min_age:max_age:r-this.degrees[1]<this.degrees[2]-r?min_age:max_age)}},get_degree_by_age:function(t){var e=t>=min_age&&max_age>=t?this.degree_steps[t-min_age]:this.degrees[1];return 0>e&&(e=360+e),e},get_radian_by_age:function(t){var e=t-min_age;1==poll.degrees[0]&&(e=max_age-min_age-(t-min_age));var n=t>=min_age&&max_age>=t?this.degree_steps[e]:this.degrees[1];return 0>n&&(n=360+n),Math.radians(n)},drag_age:function(t){var e=parseInt(t.x-w2),n=parseInt(h2-t.y);this.agepicker_age_by_coord(e,n)},agemousedown:function(t){var e=parseInt(t.clientX-w2),n=parseInt(h2-t.clientY);this.agepicker_age_by_coord(e,n)},interest_picker_show:function(){var t=280,e=30,n=2*e,r=360/interests.length;poll.stage_d3.select(".character").attr("data-percent",user.salary_percent);var i=poll.stage_d3.append("div").classed("interest_picker",!0),o=i.selectAll("svg").data(interests).enter().append("svg").attr("class",function(){return"interest_item "+g()}).attr("id",function(t){return"i"+t.id}).attr({width:n,height:n}).style("top",function(n,i){return h2+t*Math.sin(Math.radians(i*r))-e}).style("left",function(n,i){return w2-t*Math.cos(Math.radians(i*r))-e}).on("click",function(t){poll.by_interest(t.id)});poll.stage_d3.select(".stage-bk").append("defs").append("clipPath").attr("id","clip-mask").append("rect").attr({width:poll.stage_w+20,height:poll.stage_h+20,x:0,y:poll.stage_h+2}),poll.stage_d3.select(".stage-bk").append("circle").classed("mask",!0).attr({cx:poll.stage_w/2+1,cy:poll.stage_h/2+1,r:poll.stage_h/2,"clip-path":"url(#clip-mask)"}),o.append("circle").attr({cx:e,cy:e,r:e}),o.append("text").text(function(t){return t.name.substr(0,4)}).attr({x:12,y:35}),poll.interest_draw(),poll.npicker_function=function(t){t=+t,user.salary>=t&&(user.salary_percent=Math.round10(100*t/user.salary),poll.stage_d3.select(".character").attr("data-percent",user.salary_percent),poll.sublabel(poll.stage_d3.select(".interest_picker .interest_item#i"+user.interest+" text").text()+" ("+user.salary_percent+"%)"),poll.interest_percent_draw(100*t/user.salary/100))},poll.npicker_create(".stage",".percent_picker",user.salary,poll.npicker_sal_size,h2,w2+(isf()?-180:0),0),poll.stage.find(".character").on("DOMMouseScroll mousewheel",function(t,e){var n=+$(".character").attr("data-percent");up(t,e)?100>n&&++n:n>0&&--n,$(".character").attr("data-percent",n),poll.interest_percent_draw(n/100),user.salary_percent=n,poll.npicker_set(".percent_picker",Math.round10(user.salary*n/100),poll.npicker_sal_size),t.stopPropagation()}),onscrollup=function(){poll.interest_down()},onscrolldown=function(){poll.interest_up()}},interest_draw:function(){d3.selectAll(".interest_picker .interest_item").classed("selected",!1),poll.sublabel(d3.select(".interest_picker .interest_item#i"+user.interest).classed("selected",!0).select("text").text()+" ("+user.salary_percent+"%)")},interest_up:function(){var t=int_ids.indexOf(user.interest);-1!=t&&(user.interest=t<interests.length-1?int_ids[t+1]:int_ids[0]),this.interest_draw()},interest_down:function(){var t=int_ids.indexOf(user.interest);-1!=t&&(user.interest=t>0?int_ids[t-1]:int_ids[interests.length-1]),this.interest_draw()},by_interest:function(t){user.interest!=t&&(user.interest=t,this.interest_draw())},interest_percent_draw:function(t){var e=200,n=2*e*t,r=2*e-n;d3.select("#clip-mask rect").attr("y",r).attr("height",n)},choose_category:function(){category=categories.filter(function(t){return t.id==user.category})[0],0==category.outrun?(male.outrun=!0,male.gap_percent=category.percent):(female.outrun=!0,female.gap_percent=category.percent)},choose_interest:function(){interest=interests.filter(function(t){return t.id==user.interest})[0].items.sort(function(t,e){return t.cost-e.cost}),interest_level_map=[];for(var t=1;t<interest.length;++t)interest_level_map.push(Math.ceil10(interest[t].cost/interest[0].cost))},create_next_button:function(){$(".poll").append($("<div class='next-slider slider' data-steps-for-on='3'><div class='off'>></div><div class='on'>"+locale.general.next+"</div></div>").on("DOMMouseScroll mousewheel",function(t,e){var n=$(this),r=+n.attr("data-steps-for-on"),i=n.find(".off"),o=n.find(".on"),a=!1;if(up(t,e))if(r>1&&3>=r)--r,a=!0;else{--r;var s=3-r,l=i.width()/3,u=.7/3;o.css({color:s>=2?"#ededed":"#939393"}),i.text(0!=s?"":">").css({left:s*l,"background-color":"rgba(19, 166, 17,"+(.3+u*s)+")"}),fn("poll.next_function"),o.animate({color:"#939393"}),i.animate({left:0,"background-color":"rgba(19, 166, 17,0.3)"},{complete:function(){i.text(">")}}),n.attr("data-steps-for-on",3)}else 3>r&&(++r,a=!0);if(a){var s=3-r,l=i.width()/3,u=.7/3;o.css({color:s>=2?"#ededed":"#939393"}),i.text(0!=s?"":">").css({left:s*l,"background-color":"rgba(19, 166, 17,"+(.3+u*s)+")"}),n.attr("data-steps-for-on",r)}t.stopPropagation()}));var t=$(".next-slider");t.css({top:h-t.outerHeight()-25,left:w-t.outerWidth()-100}),t.find(".on").on("click",function(){fn("poll.next_function")}).on("mousedown",function(t){t.stopPropagation()})},create_prev_button:function(){$(".poll").append($("<div class='prev-slider slider' data-steps-for-on='3'><div class='on'>"+locale.general.prev+"</div><div class='off'><</div></div>").on("DOMMouseScroll mousewheel",function(t,e){var n=$(this),r=+n.attr("data-steps-for-on"),i=n.find(".off"),o=n.find(".on"),a=!1;if(up(t,e))if(r>1&&3>=r)--r,a=!0;else{--r;var s=3-r,l=i.width()/3,u=.7/3;o.css({color:s>=2?"#ededed":"#939393"}),i.text(0!=s?"":">").css({left:-s*l,"background-color":"rgba(19, 166, 17,"+(.3+u*s)+")"}),fn("poll.prev_function"),o.animate({color:"#939393"}),i.animate({left:0,"background-color":"rgba(19, 166, 17,0.3)"},{complete:function(){i.text("<")}}),n.attr("data-steps-for-on",3)}else 3>r&&(++r,a=!0);if(a){var s=3-r,l=i.width()/3,u=.7/3;o.css({color:s>=2?"#ededed":"#939393"}),i.text(0!=s?"":"<").css({left:-s*l,"background-color":"rgba(19, 166, 17,"+(.3+u*s)+")"}),n.attr("data-steps-for-on",r)}t.stopPropagation()}));var t=$(".prev-slider");t.css({top:h-t.outerHeight()-25,left:100}),t.find(".on").on("click",function(){fn("poll.prev_function")}).on("mousedown",function(t){t.stopPropagation()})},prev_function:function(){params_back()},npicker_create:function(t,e,n,r,i,o,a){var s=d3.select(t).append("div").classed(e.replace(".","")+" abs npicker",!0).attr({max:n}).style({top:i+"px",left:o+"px"}),l=poll.stage.find(e),u=[];u.length=r,s.selectAll("div").data(u).enter().append("div").attr("data-pos",function(t,e){return r-e}).text(0),s.append("input").attr({type:"text",value:0,max:n,size:r,maxlength:r}).style("display","none"),l.find("input").on("keypress",validateNumber).on("DOMMouseScroll mousewheel",function(t){t.stopPropagation()}).focusout(function(){$(this).hide(),l.find("div").show()}).change(function(){poll.npicker_set(e,+$(this).val(),r)}),l.find("div[data-pos]").on("DOMMouseScroll mousewheel",function(t,e){var n=$(this),i=n.parent(".npicker"),o=+n.text();up(t,e)?9>o&&++o:o>0&&--o,poll.npicker_check(i,+n.attr("data-pos"),o,r)&&(n.text(o),poll.npicker_set(i,poll.npicker_get(i,r),r)),t.stopPropagation()}),l.on("click",function(){$(this).find("div").hide(),$(this).find("input").show().focus()}),poll.npicker_set(e,a,r)},npicker_check:function(t,e,n,r){for(var i=t.attr("max")?+t.attr("max"):Number.MAX_VALUE,o="",a=0;r>a;++a)o+=r-a!=e?t.find("div[data-pos="+(r-a)+"]").text():n;return i>=o},npicker_get:function(t,e){t=poll.stage.find(t);for(var n="",r=0;e>r;++r)n+=t.find("div[data-pos="+(e-r)+"]").text();return+n},npicker_set:function(t,e,n){t=poll.stage.find(t);var r=t.attr("max")?+t.attr("max"):Number.MAX_VALUE;if(0>e||e>r)return!1;e=e.toString().lpad("0",n);for(var i=0;n>i;++i)t.find("div[data-pos="+(n-i)+"]").text(e[i]);return t.find("input").val(e),func(poll.npicker_function)&&poll.npicker_function(e),!0},label:function(t){d3.select(".poll-label").text(t)},sublabel:function(t){var e=$(".poll-sub-label").text(t);e.css({top:h2-e.height()/2-.38*poll.stage_size2,left:w2-e.width()/2-(isf()?1:-1)*poll.stage_size2*.45})},place_human_based_on_gender:function(){isf()?(female.place="top",male.place="bottom"):(female.place="bottom",male.place="top")},gender_thumbnail:function(t){t="gender";var e=21,n=22,r=d3.select("svg.thumbnail");r.empty()&&(r=s3.append("svg").classed("thumbnail",!0));var i=r.selectAll("g").size(),o=r.append("g").classed(t+"-thumbnail",!0);o.append("circle").attr({cx:n,cy:2*n*(i+1),r:e,"stroke-width":1,stroke:"lightblue",fill:color.white}).transition().duration(500).ease("circle-in").attr({fill:"lightblue"}),o.append("svg:image").attr({x:4,y:27,width:35,height:35,"xlink:href":"assets/images/svg/m.svg",fill:color.female})},show_thumbnails:function(){var t=21,e=22,n=["gender","age","category","salary","interest","percent"],r=d3.select("svg.thumbnail");r.empty()&&(r=s3.append("svg").classed("thumbnail",!0));var i=r.selectAll("g").data(n).enter().append("g").attr("class",function(t){return t+"-thumbnail"});i.append("circle").attr("cy",function(t,n){return 2*e*(n+1)}).attr({cx:e,r:t,"stroke-width":1,stroke:"lightblue",fill:color.white}),i.append("text").text(function(t,e){return e+1}).style("font-size","15px").attr("y",function(t,n){return 2*e*(n+1)+5}).attr({x:16,width:35,height:35,"xlink:href":"assets/images/svg/m.svg",fill:color.female})}};