function init(){redraw(),params_init(),s=$("#screen"),s3=d3.select("#screen"),intro()}function redraw(){w=$(window).width(),h=$(window).height(),w2=w/2,h2=h/2,lh=Math.ceil10((h-th)/2),timeline_period_w=w*timeline_scale,timeline_month_w=timeline_period_w/reward_period,ingame&&redraw_game()}function redraw_game(){$("#screen .top").height(lh).css("top",0),$("#screen .timeline").height(th).css("top",h2-th/2),$("#screen .bottom").height(lh).css("top",lh+th),redraw_human()}function redraw_human(t){void 0===typeof t&&(t=null),male.position(t),female.position(t)}function scr_clean(t){s.empty(),exist(t)&&s.removeClass(t)}function walk(t){if(ingame&&can_scroll(total_scrolls+t)){total_scrolls+=t;var e=!0;if(1==t){total_scrolls%scrolls_for_reward==0&&(++pos,calculate_process(t),reward||any_reward()&&(reward_process(t),e=!1));var n=timeline_month_w/scroll_per_month*(total_scrolls+1)+w,r=timeline_points.length;if(n>r*timeline_month_w){var i=Math.round10(n/timeline_month_w)+1-r;timeline_tick(i)}}else pos>=0&&total_scrolls%scrolls_for_reward!=0&&(total_scrolls-Math.floor10(total_scrolls/scrolls_for_reward)*scrolls_for_reward)%(scrolls_for_reward-1)==0&&(--pos,calculate_process(t),gopast());walk_process(e?t:0)}}function can_scroll(t){return t>=0&&life_scroll_count>t}function intro(){scr_clean(),sound_button(),s.toggleClass(sintro.class);$('<div class="title">'+sintro.title+"</div>").appendTo(s),$('<div id="cont" data-pct="0"><svg id="svg" width="120" height="120" viewPort="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg"><circle class="bk" r="50" cx="60" cy="60" fill="transparent" stroke-dasharray="314.16"></circle><circle id="bar" r="50" cx="60" cy="60" fill="transparent" stroke-dasharray="314.16"></circle></svg></div>').appendTo(s);intro_fade()}function intro_fade(){var t=$(".title");t.css({top:h/2-t.height()/2,left:w/2-t.width()/2}).fadeOut(fade_time,"linear",function(){scr_clean(s.toggleClass(sintro.class)),6>steptogo?poll.show():(game_init(),game_on_load())})}function sound_button(){if(0==s.parent().find(".volume").length){var t=$('<div class="volume on"></div>').appendTo(s.parent());t.data("state",1),t.click(function(){1==+t.data("state")?(t.removeClass("on").addClass("off").data("state",0),player.mute()):(t.removeClass("off").addClass("on").data("state",1),player.unmute())})}}function epilogue(){gameoff(),scr_clean(),s.toggleClass(sepilogue.class),sendUserData(!0);var t=$('<div class="title">'+sepilogue.title+"</div>").appendTo(s);t.css({top:h/2-t.height()/2,left:w/2-t.width()/2}).fadeIn(fade_time,"linear",function(){})}function gameon(){ingame=!0}function gameoff(){ingame=!1,clearInterval(noscrollTimerId)}function game_on_load(){animated=!0;var t=category.stage.frame.load;male.animate(t),female.animate(t)}function game_init(){gameon(),isf()?(female.salary=user.salary,male.salary=user.salary+(female.outrun?-1:1)*(user.salary*(female.outrun?female.gap_percent:male.gap_percent)/100)):(male.salary=user.salary,female.salary=user.salary+(female.outrun?1:-1)*(user.salary*(female.outrun?female.gap_percent:male.gap_percent)/100)),scr_clean();var t=$('<div class="top"></div>').appendTo(s),e=$('<div class="score"><div class="tsalary"><div class="label">'+locale.game.total_salary+'</div><div class="value">0</div></div><div class="tsaved"><div class="label">'+locale.game.total_saved+'</div><div class="value">0</div></div></div>').appendTo(t);e.css({left:w-e.width()-30});var n=$('<div class="treasure"><div class="pedestal"></div><div class="red-carpet"></div></div>').css({top:lh-32-10}).appendTo(t);t.append('<div class="stage"><div class="layer bg"></div><div class="layer fg"></div></div>'),timeline=$('<div class="timeline"><div class="canvas"></div></div>').appendTo(s),timeline=timeline.find(".canvas");var r=$('<div class="bottom"></div>').appendTo(s),i=$('<div class="score"><div class="tsalary"><div class="label">'+locale.game.total_salary+'</div><div class="value">0</div></div><div class="tsaved"><div class="label">'+locale.game.total_saved+'</div><div class="value">0</div></div></div>').appendTo(r);if(i.css({left:w-i.width()-30,top:lh+th+20}),n=$('<div class="treasure"><div class="pedestal"></div><div class="red-carpet"></div></div>').css({top:lh+th+10}).appendTo(r),r.append('<div class="stage"><div class="layer bg"></div><div class="layer fg"></div></div>'),male.init(),female.init(),male.oppenent=female,female.oppenent=male,male.prepare_for_game(),female.prepare_for_game(),pos>=0){var o=timeline_month_w/scroll_per_month*(total_scrolls+1)+w,a=timeline_points.length;if(o>a*timeline_month_w){var l=Math.round10(o/timeline_month_w)+1-a;timeline_tick(l)}$(".canvas, .treasure .red-carpet").css({left:-total_scrolls*(timeline_month_w/scroll_per_month)})}male.pedestal.resume_by_position(),female.pedestal.resume_by_position(),timeline_tick(),draw_stage(0);$('<div class="m character"></div>').appendTo("top"==male.place?t:r),$('<div class="f character"></div>').appendTo("top"==female.place?t:r);redraw_game()}function draw_stage(t){var e=$("."+(0===t?"top":"bottom")+" .stage .layer.bg"),n=$("."+(0===t?"top":"bottom")+" .stage .layer.fg"),r=category.stage;$("<img/>").appendTo(e).load(function(){var t=$(this);img_scaler=lh/t.height(),t.css({top:0,left:0,height:lh,"z-index":33}),bg_width=t.width(),stage_offset=(w-bg_width)/2;for(var i=bg_width;w>i;)$('<img src="'+r.background+'"/>').css({top:0,left:i,height:lh,"z-index":33}).appendTo(e),i+=bg_width;$("<img/>").appendTo(n).css({top:0,left:0}).load(function(){var t=$(this);t.css({height:t.height()*img_scaler,"z-index":34}),t.css({left:w2-t.width()/2,top:lh-t.height()})}).attr("src",r.foreground.interior),$("<img/>").appendTo(n).css({top:0,left:0}).load(function(){var t=$(this);t.css({height:t.height()*img_scaler,"z-index":36}),t.css({left:w2-t.width()/2,top:lh-t.height()})}).attr("src",r.foreground.exterior)}).attr("src",r.background),0==t&&draw_stage(1)}function timeline_tick(t){for(var e=0;t>e;++e){var n=new Date;size=timeline_points.length,n.setTime(timeline_points[size-1].getTime()),n.setMonth(n.getMonth()+reward_period),n>timeline_end_point&&epilogue(),timeline_point=n,timeline_points.push(n)}timeline_point_draw()}function timeline_point_draw(){timeline_points.forEach(function(t,e){if(!timeline.find(".point-in-time[data-time="+t.getTime()+"]").length){var n=$('<div class="point-in-time" data-time="'+t.getTime()+'"><div class="point">'+getMonthS(t)+" "+t.getFullYear()+'</div><div class="mask"></div></div>').appendTo(timeline);if(n.css({heigth:th,line_height:th}),0==e?(prevPosition=w2,prevPositionLeft=w2-n.width()/2):(prevPosition+=timeline_period_w,prevPositionLeft=prevPosition-n.width()/2),n.css({left:prevPositionLeft}),0!=e){for(var r=0,i=0,o=e*reward_period-1,a=e*reward_period-reward_period,s=o;s>=a;--s)r+=male.event_by_month[s],i+=female.event_by_month[s];if(r>0){var l=$('<div class="reward" data-id="'+e+'"  data-count="'+r+'"></div>').appendTo($("."+male.place+" .treasure .red-carpet"));l.css({heigth:th,line_height:th}),l.css({left:prevPosition-interest_w2}),pos+1>=e&&l.hide();for(var s=0;r>s;++s)$('<div class="item i'+interest[0].class+'"></div>').appendTo(l)}if(i>0){var l=$('<div class="reward" data-id="'+e+'"></div>').appendTo($("."+female.place+" .treasure .red-carpet"));l.css({heigth:th,line_height:th}),l.css({left:prevPosition-interest_w2}),pos+1>=e&&l.hide();for(var s=0;i>s;++s)$('<div class="item i'+interest[0].class+'"></div>').appendTo(l)}}for(var u=timeline_period_w/reward_period,s=0;reward_period-1>s;++s)$('<div class="serif"></div>').css({left:prevPosition+(s+1)*u,heigth:th,line_height:th}).appendTo(timeline);n.find(".point").text(getMonthS(t)+" "+t.getFullYear()),n.attr("data-time",t.getTime())}}),$(".treasure .red-carpet").css({width:timeline_points.length*w}),timeline.css({width:timeline_points.length*w})}function calculate_process(t){if(pos>=-1){var e=t*reward_period;humans.forEach(function(t){t.tsalary+=e*t.salary,t.tsaved+=e*t.saving_for_tick})}}function walk_process(t){1==t?h_go_right():-1==t&&h_go_left(),$(".canvas, .treasure .red-carpet").css({left:-total_scrolls*(timeline_month_w/scroll_per_month)})}function any_reward(){return humans.forEach(function(t){t.has_future_reward()&&(++queueAmount,reward=!0)}),0==queueAmount?!1:!0}function reward_process(){player.play("applause"),humans.forEach(function(t){t.has_future_reward()&&(t.queue.push(function(){card_prepare(t)}),t.queue.push(function(){prepare_for_reward(t)}),t.queue.push(function(){t.mutate(1)}),t.queue.push(function(){start_reward_animation(t)}),t.queue.push(function(){hide_card(t)}),t.queue.push(function(){prepare_for_work(t)}),t.queue.start())})}function gopast(){humans.forEach(function(t){if(t.event_by_period[pos+1]>0){var e=$("."+t.place+" .treasure .red-carpet .reward[data-id="+(pos+2)+"]");e.show(),t.card.prev()}})}function card_prepare(t){var e=pos>prev_pos,n=$("."+t.place+" .treasure .red-carpet .reward[data-id="+(pos+1)+"]");e?(n.hide(),t.card.next()):n.show(),t.queue.resume()}function prepare_for_reward(t){var e=$("."+t.place+" .stage .layer.bg"),n=$("."+t.place+" .stage .layer.fg");e.animate({color:"white"},{duration:400,progress:function(r,i){e.css({left:move_size*i}),n.css({left:move_size*i}),t.prepare_reward(i,!0)},complete:function(){t.queue.resume()}})}function prepare_for_work(t){var e=$("."+t.place+" .stage .layer.bg"),n=$("."+t.place+" .stage .layer.fg");e.animate({color:"white"},{duration:400,progress:function(r,i){e.css({left:move_size-move_size*i}),n.css({left:move_size-move_size*i}),t.prepare_reward(i,!1)},complete:function(){t.queue.resume()}})}function hide_card(t){t.card.hide(),t.queue.resume()}function start_reward_animation(t){t.queue.resume()}function m(){user.gender="m",max_age=male_max_age,life_scroll_count=12*(max_age-min_age)*scroll_per_month}function f(){user.gender="f",max_age=female_max_age,life_scroll_count=12*(max_age-min_age)*scroll_per_month}function g(){return user.gender}function gender(t){"m"==t?m():f()}function ism(){return"m"==user.gender}function isf(){return"f"==user.gender}function agegroup_by_age(t){for(var e=0;e<age_groups.length;++e)if(t>=age_groups[e].min&&t<=age_groups[e].max)return e+1}function params_init(){params_read()&&params_validate()}function params_read(){var t=window.location.hash._trimLeft("#");if(params={},steptogo=0,exist(t)){"#"==t[0]&&(t=t.substr(1));for(var e=t.split("&"),n=0;n<e.length;++n){var r=e[n].split("=");2==r.length&&(params[r[0]]=isDecimal(r[1])?+r[1]:r[1])}return!0}return!1}function params_validate(){0!=steptogo||!exist(params.g)||"f"!=params.g&&"m"!=params.g||(steptogo=1,gender(params.g),poll.place_human_based_on_gender()),1==steptogo&&exist(params.a)&&params.a>=min_age&&("f"==params.g&&params.a<=female_max_age||"m"==params.g&&params.a<=male_max_age)&&(steptogo=2,user.age=params.a),2==steptogo&&exist(params.c)&&-1!=cat_ids.indexOf(params.c)&&(steptogo=3,user.category=params.c,poll.choose_category()),3==steptogo&&exist(params.s)&&isNumber(params.s)&&params.s>0&&params.s<=max_salary&&(steptogo=4,user.salary=params.s),4==steptogo&&exist(params.i)&&-1!=int_ids.indexOf(params.i)&&(steptogo=5,user.interest=params.i,poll.choose_interest()),5==steptogo&&exist(params.p)&&isNumber(params.p)&&params.p>=0&&params.p<=100&&(steptogo=6,user.salary_percent=params.p,sendUserData()),6==steptogo&&exist(params.t)&&isNumber(params.t)&&params.t>=0&&params.t<=100&&can_scroll((+params.t+1)*scrolls_for_reward)&&(pos=+params.t,total_scrolls=(pos+1)*scrolls_for_reward,start_by_time())}function params_set(t){exist(t)&&t>0&&6>=t&&(steptogo=t);var e="";if(steptogo>0&&6>=steptogo){for(var n=0;steptogo>n;++n)e+="&"+hash_map[n].alias+"="+user[hash_map[n].name];"&"==e[0]&&(e=e.substr(1)),hist||history.pushState({hash:e},"",window.location.pathname+"#"+e)}}function params_time_set(){for(var t="",e=0;steptogo>e;++e)t+="&"+hash_map[e].alias+"="+user[hash_map[e].name];t+="&t="+pos,"&"==t[0]&&(t=t.substr(1)),hist||history.pushState({hash:t},"",window.location.pathname+"#"+t)}function params_back(){if(params_read()){for(var t=0,e=["g","a","c","s","i","p"],n=0;6>n&&"undefined"!=typeof params[e[n]];++n)t=n;for(var r="#",n=0;t>n;++n)r+=e[n]+"="+params[e[n]]+"&";r=r.slice(0,-1),window.location.hash=r,window.location.reload()}}function sendUserData(t){t="undefined"==typeof t?!1:t;var e={};e.user=user,e.flag=t,$.ajax({type:"POST",url:"gap/poll",data:e,success:function(t){user.sended=t.finished,player.play("done")},error:function(){}})}function restart(){$.removeCookie("_game_id")}function start_by_time(){var t=pos*reward_period;humans.forEach(function(e){e.tsalary=t*e.salary,e.tsaved=t*e.saving_for_tick})}function progress(t){100==t&&intro_fade();var e=$("#svg #bar");if(isNaN(t))t=0;else{var n=e.attr("r"),r=2*Math.PI*n;0>t&&(t=0),t>100&&(t=100);var i=(100-t)/100*r;e.css({strokeDashoffset:i}),$("#cont").attr("data-pct",t)}}var img_scaler=1,bg_width=0,stage_offset=0,reward=!1,move_size=-300;jwerty.key("space",function(){console.log("jump")}),jwerty.key("arrow-right",function(){walk(1)}),jwerty.key("arrow-left",function(){walk(-1)});