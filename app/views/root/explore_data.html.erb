<% title t('.title') %>

<% if @questions.present? %>

  <%= form_tag(explore_data_path) do %>
    <div class="row">
      <div class="col-sm-4">
        <%= label_tag 'row', t('.form.row') %>
        <%# select_tag 'row', options_for_select(@questions.map{|x| ["#{x.code} - #{x.text}", x.code]}, params[:row]), :class => "selectpicker", :'data-live-search' => "true" %>
        <select data-live-search="true" data-hide-disabled='true' class="selectpicker" id="row" name="row">
          <% @questions.each_with_index do |question, index| %>
            <% 
              selected = (params[:row].present? && params[:row] == question.code) || (params[:col].blank? && index == 0) ? 'selected=selected ' : ''
              col = params[:col].present? ? params[:col] : @questions[1].code 
              disabled = col == question.code ? 'disabled=disabled ' : ''
            %>
            <option value="<%= question.code %>" <%= selected %><%= disabled %>><%= "#{question.code} - #{question.text}" %></option>
          <% end %>
        </select>
      </div>
      <div class="col-sm-1">
        <button id="btn-swap-vars" type="button" class="btn btn-default" title="<%= t('.form.swap') %>">
          <span class="glyphicon glyphicon-refresh"></span>
        </button>        
      </div>  
      <div class="col-sm-4">
        <%= label_tag 'col', t('.form.col') %>
        <%# select_tag 'col', options_for_select(@questions.map{|x| ["#{x.code} - #{x.text}", x.code]}, params[:col].present? ? params[:col] : @questions[1].code), :class => "selectpicker", 
          :'data-live-search' => "true", :'data-hide-disabled' => 'true' %>
        <select data-live-search="true" data-hide-disabled='true' class="selectpicker" id="col" name="col">
          <% @questions.each_with_index do |question, index| %>
            <% 
              selected = (params[:col].present? && params[:col] == question.code) || (params[:col].blank? && index == 1) ? 'selected=selected ' : ''
              row = params[:row].present? ? params[:row] : @questions.first.code 
              disabled = row == question.code ? 'disabled=disabled ' : ''
            %>
            <option value="<%= question.code %>" <%= selected %><%= disabled %>><%= "#{question.code} - #{question.text}" %></option>
          <% end %>
        </select>
      </div>
      <div class="col-sm-3">
      <%= submit_tag t('.form.submit'), :class => 'btn btn-default', :id => 'btn-submit' %>
      </div>
    </div>

    <% if @data.present? %>
      <ul class="nav nav-tabs" role="tablist">
        <% if @data[:map_percents].present? %>
          <li class="active"><a href="#tab-map" role="tab" data-toggle="tab"><%= t('.tabs.map') %></a></li>
          <li><a href="#tab-chart" role="tab" data-toggle="tab"><%= t('.tabs.chart') %></a></li>
        <% else %>
          <li class="active"><a href="#tab-chart" role="tab" data-toggle="tab"><%= t('.tabs.chart') %></a></li>
        <% end %>
        <li><a href="#tab-table" role="tab" data-toggle="tab"><%= t('.tabs.table') %></a></li>
        <li><a href="#tab-details" role="tab" data-toggle="tab"><%= t('.tabs.details') %></a></li>
      </ul>      

      <div class="tab-content">
        <% if @data[:map_percents].present? %>
          <div class="tab-pane active" id="tab-map">
            <h3>
              <%= t('.map.title', :row => @data[:row_question], :col => @data[:column_question] ).html_safe %>
              <br />
              <span class="total_responses">(<%= t('.map.title_total', :num => @data[:total_responses]) %>)</span>
            </h3>
            <div><%= t('.map.filter', :text => @data[:map_filter]) %> </div>
            <div id="map_filter" class="btn-group">
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
              <span id="default_id"><%= @data[:map_filters][0][1] %></span> <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" role="menu">
                <% @data[:map_filters].each do |filter| %>
                  <li class="map_filter"><a href="#" data-id="<%= filter[0] %>"><%= filter[1] %></a></li>
                <% end %>
              </ul>
            </div>  

            <div id="map"></div>

          </div>
        <% end %>
        <div class="tab-pane <%= 'active' if @data[:map_percents].blank? %>" id="tab-chart">
          <div id="chart"></div>
        </div>
        <div class="tab-pane" id="tab-table">
          <h3>
            <%= t('.table.title', :row => @data[:row_question], :col => @data[:column_question] ).html_safe %>
            <br />
            <span class="total_responses">(<%= t('.table.title_total', :num => @data[:total_responses]) %>)</span>
          </h3>
          <table id="datatable" class="table table-striped table-hover table-nonfluid">
            <thead>
              <tr>
                <th class="var1-col"></th>
                <th colspan="<%= (@data[:column_answers].length + 1) %>"><%= @data[:column_question] %></th>
              </tr>
              <tr>
                <th class="var1-col"><%= @data[:row_question] %></th>
                <% @data[:column_answers].each do |answer| %>
                  <th><%= answer[1] %></th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% (0..@data[:row_answers].length-1).each do |row_index| %>
                <tr>
                  <td class="var1-col"><%= @data[:row_answers][row_index][1] %></td>
                  <% (0..@data[:counts][row_index].length-1).each do |index| %>
                    <td>
                      <%= @data[:counts][row_index][index] %>
                      &nbsp;&nbsp;
                      <%= "(#{number_to_percentage(@data[:percents][row_index][index])})" %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <div class="tab-pane" id="tab-details">
          <div class="row">
            <div class="col-sm-6">
              <p>
                <strong><%= t('.details.variable') %>:</strong>
                <%= @data[:row_question] %>
              </p>
              <p>
                <strong><%= t('.details.answers') %></strong>
              </p>
              <ul>
                <% @data[:row_answers].each do |answer| %>
                  <li>
                    <%= answer[1] %>
                  </li>
                <% end %>
              </ul> 
            </div>
            <div class="col-sm-6">
              <p>
                <strong><%= t('.details.variable') %>:</strong>
                <%= @data[:column_question] %>
              </p>
              <p>
                <strong><%= t('.details.answers') %>:</strong>
              </p>
              <ul>
                <% @data[:column_answers].each do |answer| %>
                  <li>
                    <%= answer[1] %>
                  </li>
                <% end %>
              </ul> 
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
<% else %>

  <p>
    <%= t('.no_data') %>
  </p>

<% end %>
